<!DOCTYPE html>
<html>
<head>
    <title>Tucson's Best Cycling Routes</title>
    <meta charset='utf-8' />
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    
    <!--Bootstrap CSS (must come before other stylesheets)-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <!-- Custom CSS -->
    <link href="../css/style.css" rel="stylesheet">

    <!--Animation CSS and WOW.JS - Source: http://mynameismatthieu.com/WOW/docs.html-->
    <link rel="stylesheet" href="../css/animate_minify.css">
    <script src="../js/wow.min.js"></script>

    <!--Awesome Fonts Library - Source: https://fontawesome.com/start -->
    <script src="https://kit.fontawesome.com/424cd50bdd.js"></script>

   <!--Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Oswald" rel="stylesheet">

    <!--Mapbox JS & Mapbox CSS Libraries-->
    
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.52.0/mapbox-gl.css' rel='stylesheet' />
    
    <!--Mapbox APIs-->
    <!--Mapbox Search Box-->
        
        <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.css" type="text/css" />

    <!--Mapbox Directions-->
    
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.2/mapbox-gl-directions.css' type='text/css' />

    <!--Mapbox Draw-->
    
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.css' type='text/css'/>
</head>
<body>


<div id='bootstrapoverrides' class='container-fluid'>

    <!-- Main Mapbox Map -->
        <div id='map'></div>
        <div id="geocoder" class="geocoder"></div>

    <!-- Tutorial Modal -->
        <div class="modal fade bd-example-modal-lg" id="TutorialModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h6 class="modal-title" id="exampleModalLongTitle">Use the Draw Tool <button class="mapbox-gl-draw_ctrl-draw-btn mapbox-gl-draw_line" style="width:24px; height:24px; background-color:white"></button> to point & click a cycling route</h6>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <img src="../img/Tutorial.gif" alt="Gif Tutorial Animation">
              </div>
              <!--<div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              </div>-->
            </div>
          </div>
        </div>

    <!-- Primary Mapbox Window Controls in the Top Right (Zoom, Draw, Pitch, etc...) -->
        <div id="topRightControls" class="hideright"></div>

    <!-- Legend and Togglable Layer Buttons in the Bottom -->
        <div id="legend" class="hidebottom">
            <div id='toolbar'></div>
        </div>

    <!-- Tutorial and Toggle Sidebar Buttons in the Top Right -->
        <div id='maininfo'>
            <a href=# data-toggle="tooltip" data-placement="top" title="Tutorial"><button type="button" class="btn btn-custom1" data-toggle="modal" data-target=".bd-example-modal-lg"><i class="fas fa-question-circle"></i></button></a>

            <a href=# data-toggle="tooltip" data-placement="top" title="Toggle Sidebar"><button id="sidebarCollapse" type="button" class="btn btn-warning">
                <i class="fas fa-align-right"></i></button></a>
        </div>
</div>

<!-- Load My Private API Keys -->
    <script src="../js/apikeys.js"></script>

<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.52.0/mapbox-gl.js'></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.min.js"></script>
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.2/mapbox-gl-directions.js'></script>
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.js'></script>

<!--enables all animation behavior-->
<script>new WOW().init();</script>

<!--Main Javascript File-->
<script src="js/routing.js"></script>

<script type="text/javascript" src="https://code.jquery.com/jquery.min.js"></script>

<script type="text/javascript">
    $(document).ready(function () {
        $('#sidebarCollapse').on('click', function () {
            $('#presentation').toggleClass('hideleft');
        });
        $('#sidebarCollapse').on('click', function () {
            $('#topRightControls').toggleClass('hideright');
        });

        //Want to be able to show/hide the bottom legend on click of the Toggle Sidebar Button
        $('#sidebarCollapse').on('click', function () {
            $('#legend').toggleClass('hidebottom');
        });
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        });
    });
</script>
    
<!--Bootstrap Scripts-->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<!-- Open Route Service Javascript API - For Improved Routing -->   
    <script src="../js/dist/ors-js-client.js"></script>

<!-- Proof Of Concept ORS Directions Call -->
    <script>
      window.addEventListener("load", function() {

        //Design and add two Mapbox Markers that can be dragged around map
          var startMarker = new mapboxgl.Marker({
            draggable: true,
            color: '#139900',
            })
          startMarker.setLngLat([-110.92214973449706, 32.221700917377224])
          startMarker.addTo(map);

          var endMarker = new mapboxgl.Marker({
            draggable: true,
            color: '#660000',
            });
          endMarker.setLngLat([-110.92714973449706, 32.229700917377224])
          endMarker.addTo(map);

        //This returns the first set of directions based on where the two Mapbox Markers are loaded
          gimmeDirections();

        //This re-calculates directions once a marker being 'done' being dragged around.
        //I probably don't need the if-else statement, and could just remove the directions immediately
        //but I'm keeping it in for now, as an added logical check, behavior is working as I want it to
        //But yea, before it calc's the directions, it checks if directions are already loaded on screen
        //if directions are loaded on screen, it removes them, then re-calc's the directions
          function onDragEnd() {
            var lng = this.getLngLat().lng; //I dont think I need this anymore
            var lat = this.getLngLat().lat; //I dont think I need this anymore
            // console.log("lng:" + lng);
            // console.log("lat:" + lat);
            if (map.isSourceLoaded("testdirections")) {
              map.removeLayer("AnyIdThatIWant");
              map.removeSource("testdirections");
              gimmeDirections();
            }
            else {
              //I dont think it will ever reach this command, since 'testdirections' will always be loaded beforehand
              gimmeDirections();
            }
          }
          
        //This initiates the above function. i.e. Anytime a Marker is dragged, run the onDragEnd Function
          endMarker.on('dragend', onDragEnd);
          startMarker.on('dragend', onDragEnd);
          
        //This calls the OpenRouteService Cycling Routing Algorthm API
        //and calculates the route based on the start and end Mapbox Markers       
          function gimmeDirections (){
            let orsDirections = new Openrouteservice.Directions({
              api_key: API.ors //turn this off for custom API
               // host: "http://localhost:8080/openrouteservice_war" //turn this on for custom API
            });

            orsDirections.calculate({
              //Various Paramaters for OpenRouteService Directions Calculation
                // host: "http://localhost:8080/openrouteservice_war", //turn this on for custom API
                // extra_info: ["waytype"], //turn this on for custom API
                // elevation: false, //turn this on for custom API
                // preference: "fastest", //turn this on for custom API
                // options: {
                //   profile_params: {
                //       weightings: {
                //           green: 0
                //       }
                //   }
                // },
                coordinates: [Object.values(startMarker.getLngLat()), Object.values(endMarker.getLngLat())],
                profile: "cycling-regular",
                preference: "recommended", //fastest, shortest, recommended
                extra_info: ["waytype", "steepness"], //“steepness”, “suitability”, “surface”, “waycategory”, “waytype”, “tollways”, “traildifficulty”, “roadaccessrestrictions”
                format: "geojson",
                units: "mi" //km, mi, m
            })

              //Sets the directions as a json 
                .then(function(json) {
                  emptydirections = json;
                  console.log(JSON.stringify(json));

                  //Use Mapbox to visualize json directions on Map
                    map.addSource('testdirections', { type: 'geojson', data: emptydirections });
                    map.addLayer({
                      "id": "AnyIdThatIWant",
                      "type": "line",
                      "source": "testdirections",
                      "paint": {
                        "line-color": "black",
                        "line-opacity": 0.75,
                        "line-width": 3
                      }
                    });
                })
              //If error, throw error message
                .catch(function(err) {
                  console.error(err);
                });
          };
      });  //End window.addEventListener("load")
     

    </script>

</body>
</html> 