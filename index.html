<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Tucson's Best Cycling Routes</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.52.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.52.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }



        #instructions {
            height:30px;
            min-height:300px;
            width: 250px;
            position: absolute;
            top: 120px;
            left: 10px;
            background-color: rgba(255, 255, 255, .4);
            border: solid 3px #A0A0A0;
            padding: 15px;
            text-align: left;
            font-family: 'Arial';
            margin: 0;
            font-size: 13px;
            overflow-y: scroll; /*scroll after max height is reached*/
            }

        #menu {
            /*background: #fff;*/
            position: absolute;
            z-index: 1;
            /*top: 20px;*/
            left: 10px;
            border-radius: 3px;
            width: 150px;
            padding:15px;
            /*border: 1px solid rgba(0,0,0,0.4);*/
            font-family: 'Open Sans', sans-serif;
            }
             
        #menu a {
            font-size: 13px;
            color: #404040;
            display: block;
            margin: 0;
            padding: 0;
            padding: 10px;
            text-decoration: none;
            border-bottom: 1px solid rgba(0,0,0,0.25);
            text-align: center;
            }
             
        #menu a:last-child {
            border: none;
            }
             
        #menu a:hover {
            background-color: #f8f8f8;
            color: #404040;
            }
             
        #menu a.active {
            background-color: #3887be;
            color: #ffffff;
            }
             
        #menu a.active:hover {
            background: #3074a4;
            }

        #calculated-line p {
            margin:0px;
        }

    </style>
</head>
<body>

<!--Mapbox APIs-->
<!--Mapbox Search Box-->
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.3.0/mapbox-gl-geocoder.min.js'></script>
<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.3.0/mapbox-gl-geocoder.css' type='text/css' />
<!--Mapbox Directions-->
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.0/mapbox-gl-directions.js'></script>
<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.0/mapbox-gl-directions.css' type='text/css' />
<!--Mapbox Draw-->
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.js'></script>
<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.css' type='text/css'/>


<!--Initialize Map, Menu, & Info Box-->
<div id='map'></div>
<nav id="menu"></nav> 
<div class='info-box'>
    <div id='instructions'>
        <div id="calculated-line"></div>
    </div>
</div>


<script>

//---------------------------------------------------------------------------------------
// ------------------------------- Step 1: Create The Map -------------------------------
//---------------------------------------------------------------------------------------
// All parameter options such as attributionControl, minZoom, style, etc... are found here... https://docs.mapbox.com/mapbox-gl-js/api/#map

mapboxgl.accessToken = 'pk.eyJ1IjoiZHlsYW5jIiwiYSI6Im53UGgtaVEifQ.RJiPqXwEtCLTLl-Vmd1GWQ';
var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/mapbox/light-v9', // stylesheet location
    center: [-110.9747, 32.2226 ], // starting position [lng, lat]
    zoom: 13, // starting zoom
    attributionControl: false, // Removed default attribution and put custom attribution in below
    maxBounds: [[-111.1,32], [-110.6, 32.5]], //Southwest & Northeast Bounds
});

//---------------------------------------------------------------------------------------
// --------------------------- Step 2: Add Data Layers  -----------------------------
//---------------------------------------------------------------------------------------

map.on('load', function() {  
    map.addSource('hawks', {
        type: 'geojson',
        data: 'https://raw.githubusercontent.com/Dylansc22/sourcedata/master/Hawks.geojson'
    });
    map.addLayer({
        id: 'Pedestrian Crosswalks',
        source: 'hawks',
        type: 'circle', // 'circle' works... 'fill', 'line', 'symbol' don't work - they worked up through version 0.19
        layout: { 'visibility': 'visible'},
        paint: {'circle-radius': 3.5, 'circle-color': '#dd885d'},
    });
});

//---------------------------------------------------------------------------------------
// -------------    Step 3: Add Data Layers Toggle Button   -----------------------------
//---------------------------------------------------------------------------------------


var toggleableLayerIds = [ 'Pedestrian Crosswalks', 'Future Buttons Here' ]; //Add toggleable layer ids here
 
for (var i = 0; i < toggleableLayerIds.length; i++) {
var id = toggleableLayerIds[i];
 
var link = document.createElement('a');
link.href = '#';
link.className = 'active';
link.textContent = id;
 
link.onclick = function (e) {
var clickedLayer = this.textContent;
e.preventDefault();
e.stopPropagation();
 
var visibility = map.getLayoutProperty(clickedLayer, 'visibility');
 
if (visibility === 'visible') {
map.setLayoutProperty(clickedLayer, 'visibility', 'none');
this.className = '';
} else {
this.className = 'active';
map.setLayoutProperty(clickedLayer, 'visibility', 'visible');
}
};
 
var layers = document.getElementById('menu');
layers.appendChild(link);
}

//---------------------------------------------------------------------------------------
// --------------------------- Step 4: Create Custom Controls -----------------------------
//---------------------------------------------------------------------------------------

var draw = new MapboxDraw({
  displayControlsDefault: false,
  controls: {
    line_string: true,
    trash: true,
  },
  styles: [
    // For more info - Mapbox GL Style Spec - https://docs.mapbox.com/mapbox-gl-js/style-spec
    // ACTIVE (being drawn)
    // line stroke
    {
      "id": "gl-draw-line", // Required String - Unique layer name
      "type": "line", //Required types: fill, line, symbol, circle, heatmap, fill-extrusion, raster, hillshade, background)
      "filter": ["all", ["==", "$type", "LineString"], ["!=", "mode", "static"]], 
      "layout": { 
        "line-cap": "round", //e.g. butt (default), round, square
        "line-join": "round" //miter (default), bevel, round
      },
      "paint": { 
        "line-color": "#81A4CD", 
        "line-dasharray": [2, 4],
        "line-width": 2,
        "line-opacity": 0.7
        //line-translate
        //line-gap-width
        //line-gradient
        //etc...
      }
    },
    // vertex point halos - must come before vertex, because these are two layers of circles
    {
      "id": "gl-draw-polygon-and-line-vertex-halo-active",
      "type": "circle",
      "filter": ["all", ["==", "meta", "vertex"], ["==", "$type", "Point"], ["!=", "mode", "static"]],
      "paint": {
        "circle-radius": 8,
        "circle-color": "#FFF" 
      }
    },
    // vertex points
    {
      "id": "gl-draw-polygon-and-line-vertex-active",
      "type": "circle",
      "filter": ["all", ["==", "meta", "vertex"], ["==", "$type", "Point"], ["!=", "mode", "static"]],
      "paint": {
        "circle-radius": 5,
        "circle-color": "#3E7CB1", 
      }
    },
    // midpoint point halos
    {
      "id": "gl-draw-polygon-and-line-midpoint-halo-active",
      "type": "circle",
      "filter": ["all", ["==", "meta", "midpoint"], ["==", "$type", "Point"], ["!=", "mode", "static"]],
      "paint": {
        "circle-radius": 6,
        "circle-color": "#FFF" 
      }
    },
    // midpoint points
    {
        "id": "gl-draw-polygon-and-line-midpoint-active",
        "type": "circle",
        "filter": ["all", ["==", "meta", "midpoint"], ["==", "$type", "Point"], ["!=", "mode", "static"]],
        "paint": {
            "circle-radius": 4,
            "circle-color": "#3E7CB1",
        }
    },
  ]
});

// add create, update, or delete actions
map.on('draw.create', updateRoute);
map.on('draw.update', updateRoute);
map.on('draw.delete', removeRoute);

// use the coordinates you just drew to make your directions request
function updateRoute() {
  removeRoute(); // overwrite any existing layers
  var data = draw.getAll();
  var answer = document.getElementById('calculated-line');
  var lastFeature = data.features.length - 1;
  var coords = data.features[lastFeature].geometry.coordinates;
  var newCoords = coords.join(';')
  getMatch(newCoords);
}

// make a directions request
function getMatch(e) {
  var url = 'https://api.mapbox.com/directions/v5/mapbox/cycling/' + e +'?geometries=geojson&steps=true&&access_token=' + 'pk.eyJ1IjoiZHlsYW5jIiwiYSI6Im53UGgtaVEifQ.RJiPqXwEtCLTLl-Vmd1GWQ';
  var req = new XMLHttpRequest();
  req.responseType = 'json';
  req.open('GET', url, true);
  req.onload  = function() {
    var jsonResponse = req.response;
    var distance = jsonResponse.routes[0].distance*0.001*0.621371;
    var duration = jsonResponse.routes[0].duration/60;
    var steps = jsonResponse.routes[0].legs[0].steps;
    var coords = jsonResponse.routes[0].geometry;
   
    //Return Various Results to Console Log for Troubleshooting
    //  console.log(steps);
    console.log(coords);
    //  console.log(distance);
    // console.log(duration);

    // get distance and duration
    instructions.insertAdjacentHTML('beforeend', '<p>' +  'Distance: ' + 0.621371*distance.toFixed(2) + ' mi<br>Duration: ' + duration.toFixed(2) + ' minutes' + '</p>');

    //Get Route Direction On Load Map
    steps.forEach(function(step){
        instructions.insertAdjacentHTML('beforeend', '<p>' + step.maneuver.instruction + '</p>')
    });

    //Add The Route To The Map
    addRoute(coords);
  };
  req.send();
}

// adds the route as a layer on the map
function addRoute (coords) {
  // check if the route is already loaded
  if (map.getSource('route')) {
    map.removeLayer('route')
    map.removeSource('route')
  } else{
    map.addLayer({
      "id": "route",
      "type": "line",
      "source": {
        "type": "geojson",
        "data": {
          "type": "Feature",
          "properties": {},
          "geometry": coords
        }
      },
      "layout": {
        "line-join": "round",
        "line-cap": "round"
      },
      "paint": {
        "line-color": "#0F9D58", //3b9ddd
        "line-width": 4,
        "line-opacity": 0.8
      }
    }),

    //Add directional arrows to route
    map.addLayer({
      id: 'routearrows',
      type: 'symbol',
      source: 'route',
      layout: {
        'symbol-placement': 'line',
        'text-field': 'â–¶',
        'text-size': {
          base: 2,
          stops: [[12, 24], [22, 60]]
        },
        'symbol-spacing': {
          base: 1,
          stops: [[12, 30], [22, 160]]
        },
        'text-keep-upright': false
      },
      paint: {
        'text-color': '#0F9D58',
        'text-halo-color': 'hsl(55, 11%, 96%)',
        'text-halo-width': 3
      }
    });



  };
}




// remove the layer if it exists
function removeRoute () {
  if (map.getSource('route')) {
    map.removeLayer('route');
    map.removeSource('route');
    map.removeLayer('routearrows');
    map.removeSource('routearrows');
    instructions.innerHTML = '';
    //I think I can delete this since I added the above line recently document.getElementById('calculated-line').innerHTML = '';
  } else  {
        return;
  }
}



//---------------------------------------------------------------------------------------
// --------------------------- Step 5: Add Custom Controls -----------------------------
//---------------------------------------------------------------------------------------


    /* No longer need regular driving directions
    //Adds driving directions to top-left corner
    map.addControl(new MapboxDirections({
        accessToken: 'pk.eyJ1IjoiZHlsYW5jIiwiYSI6Im53UGgtaVEifQ.RJiPqXwEtCLTLl-Vmd1GWQ' 
    }), 'top-right');
    */

    // Adds Mapbox Search Box
    map.addControl(new MapboxGeocoder({
        accessToken: 'pk.eyJ1IjoiZHlsYW5jIiwiYSI6Im53UGgtaVEifQ.RJiPqXwEtCLTLl-Vmd1GWQ' 
    }));

    // Add User-Geolocate to the map
    map.addControl(new mapboxgl.GeolocateControl({
        positionOptions: {
        enableHighAccuracy: true
        },
        trackUserLocation: true
        }));

    // Add zoom and rotation controls to the map
    map.addControl(new mapboxgl.NavigationControl());

    // Add the draw tool to the map
    map.addControl(draw);

    // Shrinks Attribution to a small hover icon for displays 640px or less
    map.addControl(new mapboxgl.AttributionControl({
            compact: true,   
        }));


</script>


</body>
</html> 